jQuery(document).ready(function ($) {
    const apiKey = aimatic_writer_vars.api_key;
    const modelId = aimatic_writer_vars.model_id || 'openai/gpt-3.5-turbo';
    const autoImages = aimatic_writer_vars.auto_images;
    const imageCount = parseInt(aimatic_writer_vars.image_count) || 3;

    const generateBtn = $('#aimatic-generate-btn');
    const publishBtn = $('#aimatic-publish-btn');
    const status = $('#aimatic-status');
    const publishMessage = $('#aimatic-publish-message');

    let uploadedImages = [];
    let featuredImageId = null;
    let imagesProcessing = false;
    let articleComplete = false;

    function getEditor() {
        return (typeof tinymce !== 'undefined') ? tinymce.get('aimatic_editor') : null;
    }

    function setEditorContent(content) {
        const editor = getEditor();
        if (editor && editor.initialized) {
            editor.setContent(content);
        } else {
            $('#aimatic_editor').val(content);
        }
    }

    function getEditorContent() {
        console.error('‚ùå Editor not initialized');
        return;
    }

    try {
        const editorBody = editor.getBody();
        console.log(`   Editor body found:`, editorBody);

        const imgElement = editor.dom.create('img', {
            src: imageUrl,
            alt: alt,
            style: 'max-width:100%;height:auto;display:block;margin:10px 0;'
        });
        console.log(`   Image element created:`, imgElement);

        if (afterElement === 'title') {
            const h1 = editorBody.querySelector('h1');
            console.log(`   Looking for H1... Found:`, h1);

            if (h1) {
                h1.parentNode.insertBefore(imgElement, h1.nextSibling);
                console.log('‚úÖ Image inserted after H1 title');
            } else {
                editorBody.insertBefore(imgElement, editorBody.firstChild);
                console.log('‚úÖ Image inserted at top (no H1)');
            }
        } else {
            const allParagraphs = Array.from(editorBody.querySelectorAll('p'));
            console.log(`   Total paragraphs found: ${allParagraphs.length}`);

            const paragraphsWithoutImages = allParagraphs.filter(p => !p.querySelector('img'));
            console.log(`   Paragraphs without images: ${paragraphsWithoutImages.length}`);
            console.log(`   Target position: ${afterElement}`);

            if (paragraphsWithoutImages.length > afterElement && paragraphsWithoutImages[afterElement]) {
                const targetParagraph = paragraphsWithoutImages[afterElement];
                console.log(`   Target paragraph:`, targetParagraph.textContent.substring(0, 50));

                targetParagraph.parentNode.insertBefore(imgElement, targetParagraph.nextSibling);
                console.log('‚úÖ Image inserted after paragraph', afterElement);
            } else {
                editorBody.appendChild(imgElement);
                console.log('‚úÖ Image appended at end');
            }
        }

        // Verify image is in DOM
        const imagesInEditor = editorBody.querySelectorAll('img');
        console.log(`   Total images in editor now: ${imagesInEditor.length}`);

        // Trigger editor update
        editor.fire('change');
        editor.fire('input');
        editor.save(); // Force save to textarea

        console.log('‚úÖ [SUCCESS] Image successfully added to DOM');

    } catch (e) {
        console.error('‚ùå [ERROR] Image insertion failed:', e);
    }

    // scrollEditorToBottom(); // Disabled as per user request
}

    function showProgressModal() {
        $('#aimatic-image-progress-modal').css('display', 'flex');
        $('#aimatic-progress-content').html('<p>‚è≥ Starting image processing...</p>');
    }

    function hideProgressModal() {
        $('#aimatic-image-progress-modal').css('display', 'none');
    }

    function updateProgress(message, percent) {
        const content = $('#aimatic-progress-content');
        content.append(`<p>${message}</p>`);
        content.scrollTop(content[0].scrollHeight);

        $('#aimatic-progress-bar').css('width', percent + '%');
        $('#aimatic-progress-percent').text(Math.round(percent) + '%');
    }

    function checkIfReadyToPublish() {
        if (articleComplete && !imagesProcessing) {
            status.text('‚úÖ Ready to publish!');
            publishBtn.prop('disabled', false).show();
            publishMessage.removeClass('error').addClass('success').text('Article and images are ready!');
        } else if (articleComplete && imagesProcessing) {
            status.text('‚è≥ Please wait, processing images...');
            publishBtn.prop('disabled', true).show();
            publishMessage.removeClass('success').addClass('error').text('Please wait while images are being uploaded...');
        }
    }

        async function processImagesInBackground(topic) {
        imagesProcessing = true;
        console.log('üîÑ Background: Fetching images for:', topic);

        if (articleComplete) {
            showProgressModal();
            updateProgress('üîç Fetching images from stock APIs...', 5);
        }

        try {
            const response = await $.post(aimatic_writer_vars.ajax_url, {
                action: 'aimatic_writer_fetch_images',
                nonce: aimatic_writer_vars.nonce,
                query: topic,
                count: imageCount
            });

            if (!response.success || !response.data || response.data.length === 0) {
                console.log('‚ùå No images found');
                updateProgress('‚ùå No images found for this topic', 100);
                setTimeout(() => {
                    hideProgressModal();
                    imagesProcessing = false;
                    checkIfReadyToPublish();
                }, 2000);
                return;
            }

            const totalImages = response.data.length;
            console.log('‚úì Fetched:', totalImages, 'images');
            updateProgress(`‚úÖ Found ${totalImages} images`, 10);

            for (let i = 0; i < totalImages; i++) {
                const img = response.data[i];
                const progressPercent = 10 + ((i / totalImages) * 85);

                updateProgress(`‚¨ÜÔ∏è Uploading image ${i + 1}/${totalImages}...`, progressPercent);
                console.log(`üîÑ Uploading image ${i + 1}/${totalImages}...`);

                let uploadSuccess = false;
                let retryCount = 0;
                const maxRetries = 2;

                while (!uploadSuccess && retryCount <= maxRetries) {
                    try {
                        const uploadResponse = await $.post(aimatic_writer_vars.ajax_url, {
                            action: 'aimatic_writer_upload_image',
                            nonce: aimatic_writer_vars.nonce,
                            image_url: img.url,
                            alt_text: img.alt
                        });

                        if (uploadResponse.success && uploadResponse.data) {
                            uploadSuccess = true;
                            console.log(`‚úì Uploaded: ${uploadResponse.data.url}`);
                            updateProgress(`‚úÖ Image ${i + 1} uploaded successfully`, progressPercent + 5);

                            uploadedImages.push({
                                url: uploadResponse.data.url,
                                id: uploadResponse.data.id,
                                alt: img.alt
                            });

                            if (i === 0) {
                                featuredImageId = uploadResponse.data.id;
                            }

                            updateProgress(`üìù Inserting image ${i + 1} into article...`, progressPercent + 10);

                            if (i === 0) {
                                insertImageAtPosition(uploadResponse.data.url, img.alt, 'title');
                                console.log('‚úì Inserted after title');
                            } else {
                                insertImageAtPosition(uploadResponse.data.url, img.alt, i * 3);
                                console.log(`‚úì Inserted after paragraph ${i * 3}`);
                            }

                            updateProgress(`‚úÖ Image ${i + 1} inserted successfully`, progressPercent + 15);
                        } else {
                            throw new Error(uploadResponse.data || 'Upload failed');
                        }
                    } catch (uploadError) {
                        retryCount++;
                        console.error(`‚ùå Upload error details:`, uploadError);
                        if (retryCount <= maxRetries) {
                            console.error(`Upload error, retrying (${retryCount}/${maxRetries})...`);
                            updateProgress(`‚ö†Ô∏è Upload failed, retrying (${retryCount}/${maxRetries})...`, progressPercent);
                            await new Promise(r => setTimeout(r, 1000));
                        } else {
                            const errorMsg = uploadError.message || 'Unknown error';
                            console.error('Upload failed after retries:', errorMsg);
                            updateProgress(`‚ùå Image ${i + 1} upload failed: ${errorMsg}`, progressPercent);
                        }
                    }
                }

                await new Promise(r => setTimeout(r, 300));
            }

            console.log('‚úÖ All images processed!');
            updateProgress('üéâ All images processed successfully!', 100);

            setTimeout(() => {
                hideProgressModal();
                imagesProcessing = false;
                checkIfReadyToPublish();
            }, 2000);

        } catch (error) {
            console.error('Background image processing error:', error);
            updateProgress('‚ùå Error: ' + error.message, 100);
            setTimeout(() => {
                hideProgressModal();
                imagesProcessing = false;
                checkIfReadyToPublish();
            }, 3000);
        }
    }

        generateBtn.on('click', async function () {
        const topic = $('#aimatic-topic').val();
        const customPrompt = $('#aimatic-prompt').val();

        if (!topic) {
            alert('Please enter a topic.');
            return;
        }

        if (!apiKey) {
            alert('Please set your OpenRouter API Key in the settings first.');
            return;
        }

        let attempts = 0;
        while (attempts < 20) {
            const editor = getEditor();
            if (editor && editor.initialized) {
                console.log('‚úì TinyMCE ready');
                break;
            }
            await new Promise(r => setTimeout(r, 200));
            attempts++;
        }

        setEditorContent('');
        status.text('Connecting...');
        generateBtn.prop('disabled', true);
        publishBtn.hide();
        publishMessage.text('');
        uploadedImages = [];
        featuredImageId = null;
        imagesProcessing = false;
        articleComplete = false;

        console.log('=== AIMatic Writer Started ===');

        const systemPrompt = "You are a professional article writer. Write a comprehensive, well-structured article using Markdown formatting (e.g., # for headings, - for lists, **bold**). Do NOT use HTML tags. Just pure Markdown text.";
        const userPrompt = `Topic: ${topic}\n${customPrompt ? 'Instructions: ' + customPrompt : ''}`;

        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "model": modelId,
                    "messages": [
                        { "role": "system", "content": systemPrompt },
                        { "role": "user", "content": userPrompt }
                    ],
                    "stream": true
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.statusText}`);
            }

            status.text('Writing article...');

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullMarkdown = "";
            let imagesStarted = false;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split("\n");

                for (const line of lines) {
                    if (line.startsWith("data: ")) {
                        const dataStr = line.slice(6);
                        if (dataStr === "[DONE]") continue;

                        try {
                            const data = JSON.parse(dataStr);
                            const content = data.choices[0]?.delta?.content || "";

                            fullMarkdown += content;

                            if (typeof marked === 'undefined') {
                                console.error('‚ùå marked.js not loaded!');
                                setEditorContent(fullMarkdown);
                                continue;
                            }

                            let html = marked.parse(fullMarkdown);
                            setEditorContent(html);
                            // scrollEditorToBottom(); // Disabled - no auto-scroll needed

                            if (!imagesStarted && autoImages == 1 && fullMarkdown.length > 200) {
                                imagesStarted = true;
                                console.log('üöÄ Starting background image processing...');
                                processImagesInBackground(topic);
                            }

                        } catch (e) {
                            console.error("Parse error:", e);
                        }
                    }
                }
            }

            console.log('=== Article Complete ===');
            articleComplete = true;
            generateBtn.prop('disabled', false);
            checkIfReadyToPublish();

        } catch (error) {
            console.error(error);
            status.text('Error: ' + error.message);
            generateBtn.prop('disabled', false);
        }
    });

$('#aimatic-post-status').on('change', function () {
    if ($(this).val() === 'future') {
        $('#aimatic-schedule-date').show();
    } else {
        $('#aimatic-schedule-date').hide();
    }
});

publishBtn.on('click', async function () {
    const title = $('#aimatic-topic').val();
    const postStatus = $('#aimatic-post-status').val();
    const date = $('#aimatic-schedule-date').val();
    const content = getEditorContent();

    if (!content) {
        alert('No content to publish.');
        return;
    }

    if (postStatus === 'future' && !date) {
        alert('Please select a date.');
        return;
    }

    publishBtn.prop('disabled', true).text('Publishing...');

    $.post(aimatic_writer_vars.ajax_url, {
        action: 'aimatic_writer_publish',
        nonce: aimatic_writer_vars.nonce,
        title: title,
        content: content,
        status: postStatus,
        date: date,
        featured_image_id: featuredImageId
    }, function (response) {
        if (response.success) {
            let msg = 'Published!';
            if (postStatus === 'draft') msg = 'Saved as Draft!';
            if (postStatus === 'future') msg = 'Scheduled!';

            publishMessage.removeClass('error').addClass('success').html(`${msg} <a href="${response.data.post_url}" target="_blank">View</a>`);
            publishBtn.text('Done');
        } else {
            publishMessage.removeClass('success').addClass('error').text('Error: ' + response.data);
            publishBtn.prop('disabled', false).text('Publish Article');
        }
    });
});
    });
